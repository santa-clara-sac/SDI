{% extends "base.html" %}
{% block title %} Lista general de gastos {% endblock %}
{% block body %}

<style>
    .form-control {
        border-radius: 0.5rem;
        height: 38px;
    }

    label.form-label {
        font-weight: 500;
    }

    .modal-content {
        border-radius: 1rem;
    }

    .form-control:focus {
        border-color: #d8dee9 !important;
        box-shadow: 0 0 0 0.2rem rgb(226, 242, 242);
    }

    .ver-pdf-btn:hover {
        text-decoration: underline !important;
    }

    .fila-seleccionada {
        background-color: #d8dee9 !important;
    }
</style>

<center>
    <h3>Seguimientos del caso: {{ caso }}</h3>
</center>

<!-- Tabla Única para todos los seguimientos -->
<div class="table-container" style="max-height: 55vh; overflow-y: auto; overflow-x: auto;">
    <table class="table table-striped" id="seguimientosTable">
        <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
            <tr>
                <th>Resolución</th>
                <th>Seguimiento</th>
                <th>Pendiente</th>
                <th>Responsable</th>
                <th>Estado</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for seguimiento in seguimientos %}
            <tr>
                <td class="text-nowrap" style="background-color: #e5e9f0;">{{ seguimiento.resolucion }}</td>
                <td class="text-nowrap" style="background-color: #e5e9f0;">{{ seguimiento.seguimiento }}</td>
                <td style="background-color: #e5e9f0;">{{ seguimiento.pendiente }}</td>
                <td style="background-color: #e5e9f0;">{{ seguimiento.responsable }}</td>
                <td style="background-color: #e5e9f0;">{{ seguimiento.estado }}</td>
                <td style="background-color: #e5e9f0;">{{ seguimiento.fecha_registro|date:"d/m/Y H:i" }}</td>

                {% if request.user.role != 1 and request.user.role != 2 %}
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary toggle-gastos-btn" data-target="gastos-{{ forloop.counter }}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </td>
                {% endif %}
            </tr>

            <!-- Sección de gastos (opcional desplegable) -->
            <tr id="gastos-{{ forloop.counter }}" class="gastos-lista" style="display: none;">
                <td colspan="7">
                    <div>
                        <h5>Gastos:</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Detalle</th>
                                    <th>Gasto Soles</th>
                                    <th>Gasto Dólares</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gasto in seguimiento.gastos.all %}
                                <tr>
                                    <td>{{ gasto.fecha }}</td>
                                    <td>{{ gasto.detalle }}</td>
                                    <td>{{ gasto.gastos_soles }}</td>
                                    <td>{{ gasto.gastos_dolares }}</td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-danger">Eliminar</a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5">Sin gastos registrados.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.toggle-gastos-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const targetId = btn.getAttribute('data-target');
                const gastosRow = document.getElementById(targetId);
                const icon = btn.querySelector('i');

                if (gastosRow.style.display === 'none' || gastosRow.style.display === '') {
                    gastosRow.style.display = 'table-row';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    gastosRow.style.display = 'none';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });
        });
    });
</script>

{% endblock %}
